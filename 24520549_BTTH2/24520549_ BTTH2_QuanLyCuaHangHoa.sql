--24520549 --Ngô Xuân Minh Hoàng

--TAO DATABASE
CREATE DATABASE QuanLyCuaHangHoa
GO

USE QuanLyCuaHangHoa

--TAO DU LIEU CAC QUAN HE
CREATE TABLE NHAVUON
(
	MANV CHAR(4) PRIMARY KEY,
	NGDAIDIEN VARCHAR(40),
	SDT VARCHAR(12),
	DIACHI VARCHAR(50)
)
GO

CREATE TABLE SANPHAM
(
	MASP CHAR(4) PRIMARY KEY,
	TENSP NVARCHAR(40),
	DVT NVARCHAR (20),
	THELOAI NVARCHAR(30) ,
	GIANHAP MONEY,
	GIABAN MONEY,
	MANV CHAR(4) FOREIGN KEY REFERENCES NHAVUON(MANV),
	CONSTRAINT RBTV_GIA CHECK(GIABAN >= (GIANHAP * 1.1) AND GIABAN <= (GIANHAP * 1.4))
)
GO

CREATE TABLE DONHANG
(
	MADH CHAR(5) PRIMARY KEY,
	NGAYBAN SMALLDATETIME,
	TONGTIEN MONEY,
	DATHANHTOAN MONEY,
	CONSTRAINT RBTV_DATHANHTOAN CHECK(DATHANHTOAN <= TONGTIEN)
)
GO

CREATE TABLE CTDH
(
	MADH CHAR(5) FOREIGN KEY REFERENCES DONHANG(MADH),
	MASP CHAR(4) FOREIGN KEY REFERENCES SANPHAM(MASP),
	SOLUONG INT,
	PRIMARY KEY(MADH,MASP)
)
GO

CREATE TABLE GIAOHANG
(
	MAGH CHAR(5) PRIMARY KEY,
	MADH CHAR(5) FOREIGN KEY REFERENCES DONHANG(MADH),
	NGAYGIAO SMALLDATETIME,
	NGGIAO VARCHAR(40),
	DT_NGGIAO VARCHAR(12),
	NGNHAN VARCHAR(40),
	DT_NGNHAN VARCHAR(12),
	DCHI_NGNHAN VARCHAR(50),
	PHISHIP MONEY,
	SOTIEN MONEY,
	DAGIAO SMALLINT,
)
GO

--NHAP DU LIEU VAO BANG

INSERT INTO NHAVUON (MANV, NGDAIDIEN, SDT, DIACHI) VALUES
('NV01', 'Tran Thi Mai', '0901234567', '100 Lac Long Quan, Q.Tay Ho'),
('NV02', 'Le Van Hung', '0988765432', '25 Duong 3/2, Q.10'),
('NV03', 'Pham Thu Thuy', '0919987654', '55 Nguyen Hue, TP.Can Tho'),
('NV04', 'Ngo Gia Tu', '0977112233', '88 Hoang Hoa Tham, Da Lat'),
('NV05', 'Do Minh Quan', '0966445566', '77 Hai Ba Trung, Ha Noi');
GO

INSERT INTO SANPHAM (MASP, TENSP, DVT, THELOAI, GIANHAP, GIABAN, MANV) VALUES
('SP01', N'Hoa Hồng', N'bó', N'hoa bó sẵn', 80000, 112000, 'NV01'), 
('SP02', N'Lan Hồ Điệp Trắng', N'chậu', N'hoa chậu', 250000, 325000, 'NV02'),
('SP03', N'Hoa Cúc', N'cành', N'hoa cắt cành', 30000, 33000, 'NV01'), 
('SP04', N'Baby Trang NK', N'cành', N'hoa nhập khẩu', 120000, 150000, 'NV04'),
('SP05', N'Chậu Sen Đá', N'chậu', N'chậu hoa cắm sẵn', 45000, 50000, 'NV03'),
('SP06', N'Cây Kim Tiền', N'chậu', N'hoa chậu', 100000, 110000, 'NV02'),
('SP07', N'Hoa Mẫu Đơn', N'cành', N'hoa nhập khẩu', 200000, 220000, 'NV04'),
('SP08', N'Bó Lily thơm', N'bó', N'hoa bó sẵn', 90000, 108000, 'NV05');
GO

INSERT INTO DONHANG (MADH, NGAYBAN, TONGTIEN, DATHANHTOAN) VALUES
('DH001', '2023-10-19', 450000, 0),
('DH002', '2023-10-20', 200000, 0),
('DH003', '2023-10-20', 140000, 50000),
('DH004', '2023-05-15', 150000, 0),
('DH005', '2024-01-05', 80000, 10000),
('DH006', '2023-11-20', 350000, 0),     
('DH007', '2023-11-20', 112000, 0),     
('DH008', '2023-11-20', 96000, 96000);   
GO

INSERT INTO CTDH (MADH, MASP, SOLUONG) VALUES
('DH002', 'SP02', 1),   
('DH003', 'SP04', 1),   
('DH004', 'SP01', 1),   
('DH006', 'SP06', 3),   
('DH007', 'SP01', 1),   
('DH008', 'SP01', 1);   
GO

INSERT INTO GIAOHANG (MAGH, MADH, NGAYGIAO, NGGIAO, DT_NGGIAO, NGNHAN, DT_NGNHAN, DCHI_NGNHAN, PHISHIP, SOTIEN, DAGIAO) VALUES
('GH001', 'DH002', '2023-10-21', 'Shipper B', '0304445556', 'Hoang Mai', '0909111222', '12 Ngo Thoi Nhiem, Q.3', 20000, 200000, 1),
('GH002', 'DH003', '2023-10-21', 'Shipper A', '0301112223', 'Minh Thu', '0987333444', '99 Ly Chinh Thang, Q.3', 15000, 90000, 1), 
('GH003', 'DH006', '2023-11-20', 'Shipper C', '0301011012', 'Quoc Hung', '0918555666', '78 Nguyen Trai, Q.5', 30000, 350000, 0),
('GH004', 'DH007', '2023-11-20', 'Shipper B', '0304445556', 'Khach Le', '0966777888', '34 Cho Lon, Q.6', 40000, 112000, 1), 
('GH005', 'DH008', '2023-11-20', 'Shipper A', '0301112223', 'Dao My', '0945999000', '15 Hang Da, Ha Noi', 25000, 0, 1);  
GO

-------------------DE 1-------------------

--CAU 1
-----A,
ALTER TABLE GIAOHANG ADD CONSTRAINT RBTV_DAGIAO CHECK(DAGIAO IN (0,1))
GO

-----B,
UPDATE DONHANG
SET TONGTIEN = TONGTIEN * 0.98
WHERE NGAYBAN > '2023-11-01'
GO

--CAU 2
-----A,
SELECT MASP,TENSP 
FROM SANPHAM
WHERE THELOAI = N'hoa chậu' AND GIABAN = (GIANHAP * 1.1)
GO

-----B,
SELECT NGGIAO,DT_NGGIAO
FROM GIAOHANG
INNER JOIN DONHANG ON GIAOHANG.MADH = DONHANG.MADH 
WHERE DAGIAO = 1 AND NGAYGIAO = '2023-10-20' AND NGAYBAN = '2023-10-19'
GO

-----C,
SELECT MASP,TENSP,SANPHAM.MANV
FROM SANPHAM
LEFT JOIN NHAVUON ON SANPHAM.MANV = NHAVUON.MANV
WHERE THELOAI = N'Hoa nhập khẩu'
GO

-----D,
(
SELECT CTDH.MADH
FROM CTDH
INNER JOIN DONHANG ON CTDH.MADH = DONHANG.MADH
INNER JOIN SANPHAM ON CTDH.MASP = SANPHAM.MASP
WHERE YEAR(NGAYBAN)=2023 AND TENSP = N'Hoa Hồng'
)

INTERSECT

(
SELECT CTDH.MADH
FROM CTDH
INNER JOIN DONHANG ON CTDH.MADH = DONHANG.MADH
INNER JOIN SANPHAM ON CTDH.MASP = SANPHAM.MASP
WHERE YEAR(NGAYBAN)=2023 AND TENSP = N'Hoa Cúc' 
)


-------------------DE 2-------------------

--CAU 1

-----A,
ALTER TABLE SANPHAM ADD CONSTRAINT RBTV_THELOAI CHECK(THELOAI IN(N'chậu hoa cắm sẵn',N'hoa bó sẵn',N'hoa chậu',N'hoa cắt cành',N'hoa nhập khẩu',N'lá trang trí'))
GO

-----B,
UPDATE GIAOHANG
SET PHISHIP = PHISHIP * 1.05
WHERE NGAYGIAO = '2023-11-20'
GO

--CAU 2

-----A,
SELECT MASP,TENSP
FROM SANPHAM
WHERE DVT = 'bó' AND GIABAN = (GIANHAP * 1.4)
GO

-----B,
SELECT NGNHAN,DT_NGNHAN
FROM GIAOHANG
INNER JOIN DONHANG ON GIAOHANG.MADH = DONHANG.MADH
WHERE NGAYBAN = '2023-10-20' AND NGAYGIAO = '2023-10-21'
GO

-----C,
SELECT DONHANG.MADH,TONGTIEN,MAGH
FROM DONHANG
LEFT JOIN GIAOHANG ON DONHANG.MADH = GIAOHANG.MADH
WHERE NGAYBAN = '2023-10-20'

-----D,
-----D,
(
SELECT CTDH.MADH
FROM CTDH
INNER JOIN DONHANG ON CTDH.MADH = DONHANG.MADH
INNER JOIN SANPHAM ON CTDH.MASP = SANPHAM.MASP
WHERE YEAR(NGAYBAN)=2023 AND TENSP = N'Hoa Hồng'
)

EXCEPT

(
SELECT CTDH.MADH
FROM CTDH
INNER JOIN DONHANG ON CTDH.MADH = DONHANG.MADH
INNER JOIN SANPHAM ON CTDH.MASP = SANPHAM.MASP
WHERE YEAR(NGAYBAN)=2023 AND TENSP = N'Hoa Cúc'
)
